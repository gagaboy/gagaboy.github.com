
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>【原创译文】创建你的第一个组件（3） - 问道</title>
	<meta name="author" content="Eric Chang">

	
	<meta name="description" content="【原创译文】创建你的第一个组件（3） 第三步 自定义新增服务 上面的例子里，createTutorial转换使用了隐式的自动实体服务create#Tutorial。我们来看下如何手动的定义和实现一个服务。 首先定义一个服务使用默认的自动实体增删改查（CrUD）实现。 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="问道" type="application/atom+xml">
	
	<link rel="canonical" href="http://gagaboy.github.io/blog/2014/06/13/moquichap10/">
	<link href="/images/QQ2013.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Nunito:400,300,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		/*$(function(){
			$('.profilepic').append("<img src='/images/MoquiWorld.png' alt='Profile Picture' style='width: 160px;' />");
		});*/
		document.write("<img src='/images/MoquiWorld.png' alt='Profile Picture' style='width: 200px;' />");

	</script>
	
</div>
<h1><a href="/">问道</a></h1>
<p class="subtitle">~~架构漫漫路修远，<br> 吾将上下而求索~~</p>

<nav id="main-nav"><ul class="main">
    <li><a href="/">首页</a></li>
    <li><a href="/blog/categories/moqui">Moqui 准备 (4)</a></li>
    <li><a href="/blog/categories/moquiying-yong-kai-fa-xi-lie-zhi-nan-yi">Moqui 应用开发系列【译】</a></li>
    <li>
    	<a href="/blog/categories/moquigai-lan">Moqui概览</a>
    	<a href="/blog/categories/yun-xing-moqui">运行Moqui</a>
    	<a href="/blog/categories/chuang-jian-shou-ge-zu-jian">第一个例子</a>
    </li>

    <li><a href="/">Moqui 架构解析（建设中...）</a></li>
    <li><a href="http://gagaboy.iteye.com/">关于我</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:gagaboy@126.com" title="Email">Email</a>
		
		
		
		
		
			<a class="github" href="https://github.com/gagaboy" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		
		
		
    	
    	
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">【原创译文】创建你的第一个组件（3）</h1>
	<div class="entry-content" itemprop="articleBody"><h2>第三步</h2>

<h3>自定义新增服务</h3>

<p>上面的例子里，createTutorial转换使用了隐式的自动实体服务create#Tutorial。我们来看下如何手动的定义和实现一个服务。</p>

<p>首先定义一个服务使用默认的自动实体增删改查（<strong><code>CrUD</code></strong>）实现。将服务定义XML文件放在下面的位置：
<em><code>runtime/component/tutorial/service/tutorial/TutorialServices.xml</code></em></p>

<!--more-->


<p>内容如下：</p>

<figure class='code'><figcaption><span>标准的服务定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;services&gt;</span>
</span><span class='line'>  <span class="nt">&lt;service</span> <span class="na">verb=</span><span class="s">&quot;create&quot;</span> <span class="na">noun=</span><span class="s">&quot;Tutorial&quot;</span> <span class="na">type=</span><span class="s">&quot;entity-auto&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;in-parameters&gt;</span>
</span><span class='line'>          <span class="nt">&lt;auto-parameters</span> <span class="na">include=</span><span class="s">&quot;all&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/in-parameters&gt;</span>
</span><span class='line'>      <span class="nt">&lt;out-parameters&gt;</span>
</span><span class='line'>          <span class="nt">&lt;auto-parameters</span> <span class="na">include=</span><span class="s">&quot;pk&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/out-parameters&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/service&gt;</span>
</span><span class='line'><span class="nt">&lt;/services&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个服务将允许Tutorial实体的所有字段传入，并总是返回主键字段（tutorialId）。这个服务定义中我们使用了基于实体的<em><code>auto-parameters</code></em>元素，这样如果我们新增了实体字段的话，它们将自动会体现在这个服务处理中。
现在，我们修改下这个服务定义来添加一个内联的实现。注意下服务中的<strong>type</strong>属性已经发生了变化，并且新增了一个actions元素。</p>

<figure class='code'><figcaption><span>指定主键规则的服务定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;service</span> <span class="na">verb=</span><span class="s">&quot;create&quot;</span> <span class="na">noun=</span><span class="s">&quot;Tutorial&quot;</span> <span class="na">type=</span><span class="s">&quot;inline&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;in-parameters&gt;</span>
</span><span class='line'>      <span class="nt">&lt;auto-parameters</span> <span class="na">include=</span><span class="s">&quot;all&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/in-parameters&gt;</span>
</span><span class='line'>  <span class="nt">&lt;out-parameters&gt;</span>
</span><span class='line'>      <span class="nt">&lt;auto-parameters</span> <span class="na">include=</span><span class="s">&quot;pk&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/out-parameters&gt;</span>
</span><span class='line'>    <span class="nt">&lt;actions&gt;</span>
</span><span class='line'>      <span class="nt">&lt;entity-make-value</span> <span class="na">entity-name=</span><span class="s">&quot;Tutorial&quot;</span> <span class="na">value-field=</span><span class="s">&quot;tutorial&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;entity-set</span> <span class="na">value-field=</span><span class="s">&quot;tutorial&quot;</span> <span class="na">include=</span><span class="s">&quot;all&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;if</span> <span class="na">condition=</span><span class="s">&quot;!tutorial.tutorialId&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;entity-sequenced-id-primary</span> <span class="na">value-field=</span><span class="s">&quot;tutorial&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/if&gt;</span>
</span><span class='line'>      <span class="nt">&lt;entity-create</span> <span class="na">value-field=</span><span class="s">&quot;tutorial&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/actions&gt;</span>
</span><span class='line'><span class="nt">&lt;/service&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在只需改变transition指向这个服务既可以调用了：</p>

<figure class='code'><figcaption><span>切换自定义的服务</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;transition</span> <span class="na">name=</span><span class="s">&quot;createTutorial&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;service-call</span> <span class="na">name=</span><span class="s">&quot;tutorial.TutorialServices.create#Tutorial&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;default-response</span> <span class="na">url=</span><span class="s">&quot;.&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/transition&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意下这个服务名称定义很像一个标准的<code>Java class</code>的命名。它有一个“包名”，本例中是在component/service目录下的&#8221;tutorial&#8221;目录（也许是以点号分割的多重目录结构）的目录名。然后是一个点号以及类名的等价物，本例中“TutorialServices”就是服务的XML文件的名称，但是没有.xml后缀。这之后又是一个点号，然后是服务的动词和名词操作，以#符号分割。</p>

<h3>Groovy服务</h3>

<p>如果你想使用Groovy（或者框架支持的其他脚本语言）而不用内联的XML动作去实现服务，怎么做呢？这种情况服务定义像这样：</p>

<figure class='code'><figcaption><span>Groovy服务定义</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;service</span> <span class="na">verb=</span><span class="s">&quot;create&quot;</span> <span class="na">noun=</span><span class="s">&quot;Tutorial&quot;</span> <span class="na">type=</span><span class="s">&quot;script&quot;</span>
</span><span class='line'>        <span class="na">location=</span><span class="s">&quot;component://tutorial/script/tutorial/createTutorial.groovy&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;in-parameters&gt;</span>
</span><span class='line'>      <span class="nt">&lt;auto-parameters</span> <span class="na">include=</span><span class="s">&quot;all&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/in-parameters&gt;</span>
</span><span class='line'>    <span class="nt">&lt;out-parameters&gt;</span>
</span><span class='line'>        <span class="nt">&lt;auto-parameters</span> <span class="na">include=</span><span class="s">&quot;pk&quot;</span> <span class="na">required=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/out-parameters&gt;</span>
</span><span class='line'><span class="nt">&lt;/service&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意这里服务的type属性已经变为&#8221;script&#8221;，并且现在有个location属性去指定脚本的位置。 <br/>
下面是这个Groovy脚本的内容：</p>

<figure class='code'><figcaption><span>Groovy脚本</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">EntityValue</span> <span class="n">tutorial</span> <span class="o">=</span> <span class="n">ec</span><span class="o">.</span><span class="na">entity</span><span class="o">.</span><span class="na">makeValue</span><span class="o">(</span><span class="s2">&quot;Tutorial&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">tutorial</span><span class="o">.</span><span class="na">setAll</span><span class="o">(</span><span class="n">context</span><span class="o">)</span>
</span><span class='line'><span class="k">if</span> <span class="o">(!</span><span class="n">tutorial</span><span class="o">.</span><span class="na">tutorialId</span><span class="o">)</span>
</span><span class='line'>  <span class="n">tutorial</span><span class="o">.</span><span class="na">setSequencedIdPrimary</span><span class="o">()</span>
</span><span class='line'><span class="n">tutorial</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>当你使用Groovy或者其他语言时，你将会用到基于可执行上下文（<strong><code>ExecutionContext class</code></strong>）这个类去调用Moqui的Java API,通常这个类在脚本里会用&#8221;<strong>ec</strong>&ldquo;这个名称。更多的API详情请看<strong><a href="http://www.moqui.org/javadoc/index.html">Java API文档</a></strong>，并查询文档中<strong><a href="http://www.moqui.org/javadoc/org/moqui/context/ExecutionContext.html">ExecutionContext</a></strong>这个类，这个类关联了很多核心的API接口。</p>
</div>


 <footer>
 	<br>
 	<br>
    <p>
      
        <a class="basic-alignment left" href="/blog/2014/06/03/moquichap9/" title="Previous Post: 【原创译文】创建你的第一个组件（2）">&lt;-- 上一篇：【原创译文】创建你的第一个组件（2）</a>
      
      
    </p>
  </footer>
</article>
  
  <br/><!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tsina">新浪微博</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_ydnote">有道云笔记</a>
<a class="jiathis_button_googleplus">Google+</a>
<a class="jiathis_button_twitter">Twitter</a>
<a class="jiathis_button_fb">Facebook</a>

<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
var jiathis_config={
	summary:"",
	shortUrl:false,
	hideMore:true
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

  <br/>
  <br/>

<DIV style="font-size:12px;BORDER-BOTTOM: #bbbbbb 1px solid; BORDER-LEFT: #bbbbbb 1px solid; BACKGROUND: #f6f6f6; HEIGHT: 130px; BORDER-TOP: #bbbbbb 1px solid; BORDER-RIGHT: #bbbbbb 1px solid" class=oec2003right> 
<DIV style="MARGIN-TOP: 10px; FLOAT: left; MARGIN-LEFT: 5px; MARGIN-RIGHT: 10px"> 
<IMG alt="" src="http://gagaboy.github.io/images/QQ2013.png" width=100 height=100></DIV> 
<DIV style="LINE-HEIGHT: 200%; MARGIN-TOP: 10px; COLOR: #000000"> 

<li>作者： <A href="http://gagaboy.github.io">Eric Chang</A> <BR> 
<li>出处： <a href="http://gagaboy.github.io">http://gagaboy.github.io/</a>
<BR><li>本文基于<a target="_blank" title="署名-非商业性使用-相同方式共享 3.0 中国大陆" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"> 
署名-非商业性使用-相同方式共享 3.0 中国大陆</a>许可协议发布<br/><li>欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文链接以及作者（上方两项信息）否则：保留追究法律责任的权利。 
</DIV></DIV> 

  <br/>

<br/>
  <section>
    <h1></h1>
    <div id="comments" aria-live="polite"><!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"gagaboy"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END --></div>
  </section>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2014 - Eric Chang - All Rights Reserved -  
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
		</div>
	</div>
	










</body>
</html>
